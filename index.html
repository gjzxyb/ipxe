<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iPXE æœåŠ¡å™¨æ§åˆ¶é¢æ¿</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --hover-color: #3730a3;
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background:
                linear-gradient(to bottom right, rgba(67, 97, 238, 0.05), rgba(55, 48, 163, 0.05)),
                linear-gradient(to right, #f8fafc 1px, transparent 1px) 0 0 / 50px 50px,
                linear-gradient(to bottom, #f8fafc 1px, transparent 1px) 0 0 / 50px 50px;
            background-attachment: fixed;
            padding: 2rem;
            position: relative;
            overflow-x: hidden;
        }

        /* æ·»åŠ åŠ¨æ€å…‰æ•ˆèƒŒæ™¯ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 0% 0%, rgba(67, 97, 238, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 100% 0%, rgba(55, 48, 163, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(67, 97, 238, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow:
                var(--card-shadow),
                0 0 0 1px rgba(67, 97, 238, 0.1);
            padding: 2rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 img {
            width: 32px;
            height: 32px;
        }

        .breadcrumb {
            background: #fff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .breadcrumb-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .breadcrumb a:hover {
            background-color: var(--bg-color);
            color: var(--hover-color);
        }

        .breadcrumb .separator {
            color: #666;
            margin: 0 5px;
        }

        .file-list {
            list-style: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: var(--bg-color);
            transform: translateX(5px);
        }

        .file-icon {
            margin-right: 12px;
            color: var(--primary-color);
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .file-name {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .file-name a {
            color: var(--text-color);
            text-decoration: none;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .file-name a:hover {
            color: var(--primary-color);
            background-color: var(--bg-color);
        }

        .file-meta {
            color: #666;
            font-size: 14px;
            margin-left: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-size, .file-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status {
            padding: 20px;
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #666;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 4px;
            background-color: #e8f5e9;
            color: #2e7d32;
            font-weight: 500;
        }

        #server-status.offline {
            background-color: #ffebee;
            color: #c62828;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .file-meta {
                display: none;
            }

            h1 {
                font-size: 20px;
            }

            .breadcrumb {
                font-size: 12px;
                padding: 10px;
            }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loading-text::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
            width: 20px;
            display: inline-block;
        }

        @keyframes dots {
            0%, 20% { content: ""; }
            40% { content: "."; }
            60% { content: ".."; }
            80%, 100% { content: "..."; }
        }

        .server-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .server-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(67, 97, 238, 0.1);
            transition: var(--transition);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .server-card:hover {
            transform: translateY(-2px);
            box-shadow:
                0 10px 15px -3px rgb(0 0 0 / 0.1),
                0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .server-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .server-status {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-running {
            background-color: #dcfce7;
            color: #166534;
        }

        .status-stopped {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .server-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-transform: none;
            letter-spacing: 0.5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--hover-color), var(--primary-color));
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #475569, #334155);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            background: #94a3b8 !important;
            box-shadow: none !important;
        }

        .btn span {
            font-size: 1.1em;
            display: inline-flex;
            align-items: center;
            transition: transform 0.2s ease;
        }

        .btn:hover:not(:disabled) span {
            transform: scale(1.1);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 60%);
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            transition: transform 0.6s ease-out, opacity 0.4s ease-out;
        }

        .btn:active::after {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            transition: 0s;
        }

        .config-editor {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-top: 2rem;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(67, 97, 238, 0.1);
        }

        .config-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;  /* æ·»åŠ è¿™è¡Œä»¥æ”¯æŒå¤šä¸ªæ ‡ç­¾è‡ªåŠ¨æ¢è¡Œ */
        }

        .config-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            cursor: pointer;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            border: 1px solid var(--border-color);
            border-bottom: none;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .config-tab:hover:not(.active) {
            background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
            transform: translateY(-1px);
        }

        .config-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .config-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
        }

        .config-content {
            background-color: white;
            border-radius: 4px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .config-textarea {
            width: 100%;
            min-height: 400px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            resize: vertical;
        }

        .save-config {
            margin-top: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .notification.error {
            background-color: #ffebee;
            color: #c62828;
        }

        .notification.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .image-list {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        .image-list-header {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            border-bottom: 1px solid var(--border-color);
            justify-content: space-between;
        }

        .image-list-title {
            font-weight: 500;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .image-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            transition: var(--transition);
        }

        .image-item:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .image-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .image-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }

        .image-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .device-list {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.95);
            overflow: hidden;
        }

        .device-list-header {
            display: grid;
            grid-template-columns: 180px 160px 140px 200px 120px auto;
            padding: 1rem;
            background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
            color: var(--text-color);
        }

        .device-item {
            display: grid;
            grid-template-columns: 180px 160px 140px 200px 120px auto;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            transition: var(--transition);
        }

        .device-item:hover {
            background: rgba(67, 97, 238, 0.05);
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-mac {
            font-family: monospace;
            font-weight: 500;
        }

        .device-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            width: fit-content;
        }

        .device-status.online {
            background-color: #dcfce7;
            color: #166534;
        }

        .device-status.offline {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .device-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .device-bios {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background: #f1f5f9;
            font-size: 0.875rem;
            width: fit-content;
        }

        .ipxe-settings {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .config-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: white;
            font-size: 1rem;
            color: var(--text-color);
            transition: var(--transition);
        }

        .config-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.1);
        }

        .config-select:hover {
            border-color: var(--primary-color);
        }

        .warning {
            color: #f59e0b;
            font-style: italic;
        }

        .iso-details {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .iso-details h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .iso-details p {
            margin: 8px 0;
        }

        input[type="file"] {
            display: none;  /* éšè—é»˜è®¤çš„æ–‡ä»¶è¾“å…¥æ¡† */
        }

        .custom-file-upload {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
        }

        .custom-file-upload:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .custom-file-upload span {
            font-size: 1.1em;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            width: 90%;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.5;
            transition: var(--transition);
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .modal-close:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h3 {
            margin: 0 0 1.5rem 0;
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .modal-content p {
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .modal-content p strong {
            color: var(--text-color);
        }

        .modal-content a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .modal-content a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a90e2'%3E%3Cpath d='M19 20H4a2 2 0 0 1-2-2V6c0-1.11.89-2 2-2h6l2 2h7c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2zm0-12H8.83l-2-2H4v12h15V8z'/%3E%3C/svg%3E" alt="æœåŠ¡å™¨å›¾æ ‡">
                iPXE æœåŠ¡å™¨æ§åˆ¶é¢æ¿
            </h1>
        </header>

        <div class="server-controls">
            <!-- HTTPæœåŠ¡å™¨å¡ç‰‡ -->
            <div class="server-card">
                <div class="server-header">
                    <div class="server-title">
                        <span>ğŸŒ</span>
                        HTTPæœåŠ¡å™¨
                    </div>
                    <div id="http-status" class="server-status status-stopped">
                        <span>âšª</span>
                        æ£€æŸ¥ä¸­...
                    </div>
                </div>
                <div class="server-actions">
                    <button id="http-start" class="btn btn-primary" onclick="controlHTTPServer('start')">
                        <span>â–¶ï¸</span>å¯åŠ¨
                    </button>
                    <button id="http-stop" class="btn btn-danger" onclick="controlHTTPServer('stop')">
                        <span>â¹ï¸</span>åœæ­¢
                    </button>
                    <button id="http-restart" class="btn btn-secondary" onclick="controlHTTPServer('restart')">
                        <span>ğŸ”„</span>é‡å¯
                    </button>
                </div>
            </div>

            <!-- TFTPæœåŠ¡å™¨å¡ç‰‡ -->
            <div class="server-card">
                <div class="server-header">
                    <div class="server-title">
                        <span>ğŸ“¡</span>
                        TFTPæœåŠ¡å™¨
                    </div>
                    <div id="tftp-status" class="server-status status-stopped">
                        <span>âšª</span>
                        æ£€æŸ¥ä¸­...
                    </div>
                </div>
                <div class="server-actions">
                    <button id="tftp-start" class="btn btn-primary" onclick="controlTFTPServer('start')">
                        <span>â–¶ï¸</span>å¯åŠ¨
                    </button>
                    <button id="tftp-stop" class="btn btn-danger" onclick="controlTFTPServer('stop')">
                        <span>â¹ï¸</span>åœæ­¢
                    </button>
                    <button id="tftp-restart" class="btn btn-secondary" onclick="controlTFTPServer('restart')">
                        <span>ğŸ”„</span>é‡å¯
                    </button>
                </div>
            </div>

            <!-- DHCPæœåŠ¡å™¨å¡ç‰‡ -->
            <div class="server-card">
                <div class="server-header">
                    <div class="server-title">
                        <span>ğŸŒ</span>
                        DHCPæœåŠ¡å™¨
                    </div>
                    <div id="dhcp-status" class="server-status status-stopped">
                        <span>âšª</span>
                        æ£€æŸ¥ä¸­...
                    </div>
                </div>
                <div class="server-actions">
                    <button id="dhcp-start" class="btn btn-primary" onclick="controlDHCPServer('start')">
                        <span>â–¶ï¸</span>å¯åŠ¨
                    </button>
                    <button id="dhcp-stop" class="btn btn-danger" onclick="controlDHCPServer('stop')">
                        <span>â¹ï¸</span>åœæ­¢
                    </button>
                    <button id="dhcp-restart" class="btn btn-secondary" onclick="controlDHCPServer('restart')">
                        <span>ğŸ”„</span>é‡å¯
                    </button>
                </div>
            </div>
        </div>

        <!-- é…ç½®ç¼–è¾‘å™¨ -->
        <div class="config-editor">
            <div class="config-tabs">
                <button class="config-tab active" onclick="switchConfig('ipxe')">iPXEè®¾ç½®</button>
                <button class="config-tab" onclick="switchConfig('images')">é•œåƒç®¡ç†</button>
                <button class="config-tab" onclick="switchConfig('devices')">è®¾å¤‡åˆ—è¡¨</button>
                <button class="config-tab" onclick="switchConfig('http')">HTTPé…ç½®</button>
                <button class="config-tab" onclick="switchConfig('dhcp')">DHCPé…ç½®</button>
            </div>
            <div class="config-content">
                <div id="config-ipxe" class="tab-content active">
                    <div class="ipxe-settings">
                        <div class="setting-group">
                            <label for="efi-file">EFI å¯åŠ¨æ–‡ä»¶</label>
                            <select id="efi-file" class="config-select" onchange="saveIPXEConfig()">
                            </select>
                        </div>
                    </div>
                </div>
                <div id="config-images" class="tab-content">
                    <div class="image-list">
                        <div class="image-list-header">
                            <div class="image-list-title">é•œåƒæ–‡ä»¶</div>
                            <div class="image-upload">
                                <label class="custom-file-upload" onclick="uploadImage()">
                                    <span>ğŸ“¤</span>ä¸Šä¼ é•œåƒ
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="config-devices" class="tab-content">
                    <div class="device-list">
                        <div class="device-list-header">
                            <div>MAC åœ°å€</div>
                            <div>IP åœ°å€</div>
                            <div>BIOS æ¨¡å¼</div>
                            <div>å¯åŠ¨æ–‡ä»¶</div>
                            <div>çŠ¶æ€</div>
                            <div>æ“ä½œ</div>
                        </div>
                        <div class="device-item">
                            <span class="device-mac">00:1A:2B:3C:4D:5E</span>
                            <span>192.168.1.100</span>
                            <span class="device-bios">UEFI</span>
                            <span>ubuntu-22.04.ipxe</span>
                            <div class="device-status online">åœ¨çº¿</div>
                            <div class="device-actions">
                                <button class="btn btn-secondary btn-sm" onclick="editDevice('00:1A:2B:3C:4D:5E')">
                                    <span>ğŸ“</span>ç¼–è¾‘
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteDevice('00:1A:2B:3C:4D:5E')">
                                    <span>ğŸ—‘ï¸</span>åˆ é™¤
                                </button>
                            </div>
                        </div>
                        <!-- æ·»åŠ æ›´å¤šç¤ºä¾‹è®¾å¤‡ -->
                        <div class="device-item">
                            <span class="device-mac">00:2C:4D:5E:6F:7G</span>
                            <span>192.168.1.101</span>
                            <span class="device-bios">Legacy</span>
                            <span>windows-pe.ipxe</span>
                            <div class="device-status offline">ç¦»çº¿</div>
                            <div class="device-actions">
                                <button class="btn btn-secondary btn-sm" onclick="editDevice('00:2C:4D:5E:6F:7G')">
                                    <span>ç¼–è¾‘</span>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteDevice('00:2C:4D:5E:6F:7G')">
                                    <span>ğŸ—‘ï¸</span>åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="config-http" class="tab-content">
                    <textarea id="http-config-editor" class="config-textarea" spellcheck="false"></textarea>
                    <div class="save-config">
                        <button class="btn btn-secondary" onclick="reloadConfig('http')">
                            <span>ğŸ”„</span>é‡æ–°åŠ è½½
                        </button>
                        <button class="btn btn-primary" onclick="saveConfig('http')">
                            <span>ğŸ’¾</span>ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
                <div id="config-dhcp" class="tab-content">
                    <textarea id="config-editor" class="config-textarea" spellcheck="false"></textarea>
                    <div class="save-config">
                        <button class="btn btn-secondary" onclick="reloadConfig('dhcp')">
                            <span>ğŸ”„</span>é‡æ–°åŠ è½½
                        </button>
                        <button class="btn btn-primary" onclick="saveConfig('dhcp')">
                            <span>ğŸ’¾</span>ä¿å­˜é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="status">
            <div id="server-info">æ­£åœ¨è·å–æœåŠ¡å™¨ä¿¡æ¯...</div>
        </footer>
    </div>

    <script>
        let currentConfig = 'ipxe';
        let configs = {
            dhcp: '',
            ipxe: '',
            http: ''
        };

        // åŠ è½½é…ç½®æ–‡ä»¶
        async function loadConfig(type) {
            try {
                const response = await fetch(`/api/config/${type}`);
                const config = await response.text();
                configs[type] = config;
                if (currentConfig === type) {
                    document.getElementById('config-editor').value = config;
                }
            } catch (error) {
                showNotification('åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥', 'error');
            }
        }

        // æ¢é…ç½®æ–‡ä»¶
        function switchConfig(type) {
            currentConfig = type;
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`config-${type}`).classList.add('active');

            // æ ¹æ®ç±»å‹åŠ è½½ä¸åŒå†…å®¹
            if (type === 'dhcp' || type === 'http') {
                document.getElementById(type === 'dhcp' ? 'config-editor' : 'http-config-editor').value = configs[type];
            } else if (type === 'images') {
                loadImages();
            } else if (type === 'devices') {
                loadDevices();
            }
        }

        // é‡æ–°åŠ è½½é…ç½®
        async function reloadConfig(type) {
            try {
                const response = await fetch(`/api/config/${type}`);
                const config = await response.text();
                configs[type] = config;
                const editorId = type === 'dhcp' ? 'config-editor' : 'http-config-editor';
                document.getElementById(editorId).value = config;
                showNotification(`${type.toUpperCase()}é…ç½®å·²é‡æ–°åŠ è½½`, 'success');
            } catch (error) {
                showNotification(`åŠ è½½${type.toUpperCase()}é…ç½®å¤±è´¥`, 'error');
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig(type) {
            const editorId = type === 'dhcp' ? 'config-editor' : 'http-config-editor';
            const config = document.getElementById(editorId).value;
            try {
                const response = await fetch(`/api/config/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: config
                });
                if (response.ok) {
                    showNotification(`${type.toUpperCase()}é…ç½®ä¿å­˜æˆåŠŸ`, 'success');
                    configs[type] = config;
                } else {
                    showNotification(`${type.toUpperCase()}é…ç½®ä¿å­˜å¤±è´¥`, 'error');
                }
            } catch (error) {
                showNotification(`${type.toUpperCase()}é…ç½®ä¿å­˜å¤±è´¥`, 'error');
            }
        }

        // æ›´æ–°HTTPæœåŠ¡å™¨çŠ¶æ€
        async function updateHTTPStatus() {
            const statusElement = document.getElementById('http-status');
            const serverInfoElement = document.getElementById('server-info');

            // æ›´æ–°ä¸ºæ£€æŸ¥ä¸­çŠ¶æ€
            statusElement.className = 'server-status';
            statusElement.innerHTML = `
                <span>ğŸ”„</span>
                æ£€æŸ¥ä¸­...
            `;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶

                const response = await fetch('/api/status', {
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const isRunning = data.status === 'running';

                statusElement.className = `server-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                statusElement.innerHTML = `
                    <span>${isRunning ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                    ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                `;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('http-start').disabled = isRunning;
                document.getElementById('http-stop').disabled = !isRunning;
                document.getElementById('http-restart').disabled = !isRunning;

                // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯
                if (isRunning) {
                    serverInfoElement.innerHTML = `
                        <span title="æœåŠ¡å™¨åœ°å€">ğŸŒ ${data.server_address}:${data.server_port}</span>
                        <span style="margin: 0 10px">|</span>
                        <span title="è¿è¡Œæ—¶é—´">â±ï¸ ${formatUptime(data.uptime)}</span>
                    `;
                } else {
                    serverInfoElement.innerHTML = `
                        <span title="çŠ¶æ€">âš ï¸ æœåŠ¡å™¨å·²åœæ­¢</span>
                    `;
                }
            } catch (error) {
                console.error('è·å–HTTPçŠ¶æ€å¤±è´¥:', error);

                // æ ¹æ®é”™è¯¯ç±»å‹è®¾ç½®ä¸åŒçš„çŠ¶æ€æ˜¾ç¤º
                if (error.name === 'AbortError') {
                    statusElement.className = 'server-status status-stopped';
                    statusElement.innerHTML = `
                        <span>âš ï¸</span>
                        å“åº”è¶…æ—¶
                    `;
                } else if (error.message.includes('Failed to fetch') ||
                         error.message.includes('ERR_CONNECTION_REFUSED')) {
                    statusElement.className = 'server-status status-stopped';
                    statusElement.innerHTML = `
                        <span>ğŸ”´</span>
                        å·²åœæ­¢
                    `;
                } else {
                    statusElement.className = 'server-status status-stopped';
                    statusElement.innerHTML = `
                        <span>âš ï¸</span>
                        è¿æ¥å¤±è´¥
                    `;
                }

                // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºå¯å¯åŠ¨
                document.getElementById('http-start').disabled = false;
                document.getElementById('http-stop').disabled = true;
                document.getElementById('http-restart').disabled = true;

                // æ›´æ–°æœåŠ¡å™¨ä¿¡æ¯
                serverInfoElement.innerHTML = `
                    <span title="é”™è¯¯">âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨</span>
                `;
            }
        }

        // æ›´æ–°DHCPæœåŠ¡å™¨çŠ¶æ€
        async function updateDHCPStatus() {
            const statusElement = document.getElementById('dhcp-status');
            try {
                const response = await fetch('/api/dhcp/status');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const isRunning = data.status === 'running';

                statusElement.className = `server-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                statusElement.innerHTML = `
                    <span>${isRunning ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                    ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                `;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('dhcp-start').disabled = isRunning;
                document.getElementById('dhcp-stop').disabled = !isRunning;
                document.getElementById('dhcp-restart').disabled = !isRunning;
            } catch (error) {
                console.error('è·å–DHCPçŠ¶æ€å¤±è´¥:', error);
                statusElement.className = 'server-status status-stopped';
                statusElement.innerHTML = `
                    <span>âš ï¸</span>
                    è¿æ¥å¤±è´¥
                `;
            }
        }

        // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const parts = [];

            if (days > 0) parts.push(`${days}å¤©`);
            if (hours > 0) parts.push(`${hours}å°æ—¶`);
            if (minutes > 0) parts.push(`${minutes}åˆ†é’Ÿ`);

            return parts.length > 0 ? parts.join(' ') : 'åˆšåˆšå¯åŠ¨';
        }

        // æ§åˆ¶DHCPæœåŠ¡å™¨
        async function controlDHCPServer(action) {
            const button = document.querySelector(`#dhcp-${action}`);
            button.disabled = true;
            try {
                const response = await fetch(`/api/dhcp/${action}`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.success) {
                    showNotification(`DHCPæœåŠ¡å™¨${getActionName(action)}æˆåŠŸ`, 'success');
                    // ç«‹å³æ›´æ–°çŠ¶æ€
                    const statusElement = document.getElementById('dhcp-status');
                    const isRunning = data.status === 'running';
                    statusElement.className = `server-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                    statusElement.innerHTML = `
                        <span>${isRunning ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                        ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                    `;
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    document.getElementById('dhcp-start').disabled = isRunning;
                    document.getElementById('dhcp-stop').disabled = !isRunning;
                    document.getElementById('dhcp-restart').disabled = !isRunning;
                } else {
                    const errorMessage = data.error ? `DHCPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥: ${data.error}` : `DHCPæœåŠ¡${getActionName(action)}å¤±è´¥`;
                    console.error(errorMessage);
                    showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error(`DHCPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥:`, error);
                showNotification(`DHCPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
            }
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    return false;
                }
                const data = await response.json();
                return data.status === 'running';
            } catch (error) {
                return false;
            }
        }

        // ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
        async function waitForServer(maxAttempts = 30, interval = 1000) {
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    const response = await fetch('/api/status');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.status === 'running') {
                            return true;
                        }
                    }
                } catch (error) {
                    // ç•¥é”™è¯¯ï¼Œç»§ç»­ç­‰å¾…
                }
                await new Promise(resolve => setTimeout(resolve, interval));
            }
            return false;
        }

        // æ§åˆ¶HTTPæœåŠ¡å™¨
        async function controlHTTPServer(action) {
            const button = document.querySelector(`#http-${action}`);
            button.disabled = true;
            const statusElement = document.getElementById('http-status');

            try {
                // æ›´æ–°UIçŠ¶æ€
                statusElement.className = 'server-status';
                statusElement.innerHTML = `
                    <span>ğŸ”„</span>
                    ${action === 'restart' ? 'é‡å¯ä¸­' : (action === 'start' ? 'å¯åŠ¨ä¸­' : 'åœæ­¢ä¸­')}...
                `;

                if (action === 'stop') {
                    // åœæ­¢æ“ä½œçš„ï¿½ï¿½æ®Šå¤„ç†
                    try {
                        // å‘é€åœæ­¢å‘½ä»¤
                        await fetch('/api/http/stop', {
                            method: 'POST',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                    } catch (error) {
                        // å¿½ç•¥ä»»ä½•é”™è¯¯ï¼Œç»§ç»­æ£€æŸ¥çŠ¶æ€
                    }

                    // ç­‰å¾…æœåŠ¡åœæ­¢
                    let maxAttempts = 10;
                    let attempts = 0;
                    let stopped = false;

                    while (attempts < maxAttempts && !stopped) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        try {
                            const response = await fetch('/api/status', {
                                headers: {
                                    'Cache-Control': 'no-cache',
                                    'Pragma': 'no-cache'
                                }
                            });
                            // å¦‚æœèƒ½è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œç»§ç»­ç­‰å¾…
                            if (response.ok) {
                                const data = await response.json();
                                if (data.status !== 'running') {
                                    stopped = true;
                                }
                            }
                        } catch (error) {
                            // å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯´æ˜æœåŠ¡å™¨å·²åœæ­¢
                            if (error.message.includes('Failed to fetch') ||
                                error.message.includes('ERR_CONNECTION_RESET') ||
                                error.message.includes('ERR_CONNECTION_REFUSED')) {
                                stopped = true;
                            }
                        }
                        attempts++;
                    }

                    // æ— è®ºå¦‚ä½•éƒ½è®¤ä¸ºåœæ­¢æˆåŠŸ
                    await updateHTTPStatus();
                    showNotification('HTTPæœåŠ¡å™¨åœæ­¢æˆåŠŸ', 'success');
                    return;
                } else {
                    // å¯åŠ¨æˆ–é‡å¯æ“ä½œ
                    try {
                        const response = await fetch(`/api/http/${action}`, {
                            method: 'POST',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        const data = await response.json();
                        if (!data.success) {
                            throw new Error(`HTTPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥`);
                        }
                    } catch (error) {
                        if ((action === 'restart' || action === 'start') &&
                            (error.message.includes('Failed to fetch') ||
                             error.message.includes('ERR_CONNECTION_RESET') ||
                             error.message.includes('ERR_CONNECTION_REFUSED'))) {
                            // è¿™æ˜¯é¢„æœŸçš„é”™è¯¯ç»§ç»­ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
                        } else {
                            throw error;
                        }
                    }

                    // ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨
                    let retries = 30;
                    let serverUp = false;

                    while (retries > 0 && !serverUp) {
                        try {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            const response = await fetch('/api/status', {
                                headers: {
                                    'Cache-Control': 'no-cache',
                                    'Pragma': 'no-cache'
                                }
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.status === 'running') {
                                    serverUp = true;
                                    await updateHTTPStatus();
                                    showNotification(`HTTPæœåŠ¡å™¨${getActionName(action)}æˆåŠŸ`, 'success');
                                    break;
                                }
                            }
                        } catch (error) {
                            statusElement.innerHTML = `
                                <span>ğŸ”„</span>
                                ${action === 'restart' ? 'é‡å¯ä¸­' : 'å¯åŠ¨ä¸­'} (å‰©ä½™é‡è¯•: ${retries})...
                            `;
                            console.log(`ç­‰å¾…æœåŠ¡å™¨å“åº”... å‰©ä½™é‡è¯•æ¬¡æ•°: ${retries}`);
                        }
                        retries--;
                    }

                    if (!serverUp) {
                        throw new Error(`æœåŠ¡å™¨${getActionName(action)}è¶…æ—¶`);
                    }
                }
            } catch (error) {
                // å¯¹äºåœæ­¢æ“ä½œï¼Œå¿½ç•¥æ‰€æœ‰é”™è¯¯
                if (action === 'stop') {
                    await updateHTTPStatus();
                    showNotification('HTTPæœåŠ¡å™¨åœæ­¢æˆåŠŸ', 'success');
                } else {
                    console.error(`HTTPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥:`, error);
                    showNotification(`HTTPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥: ${error.message}`, 'error');
                }
            } finally {
                button.disabled = false;
                // æœ€åå†æ¬¡æ£€æŸ¥çŠ¶æ€
                setTimeout(async () => {
                    try {
                        await updateHTTPStatus();
                    } catch (error) {
                        // å¯¹äºåœæ­¢æ“ä½œï¼Œå¿½ç•¥æœ€ç»ˆçŠ¶æ€æ›´æ–°å¤±è´¥çš„é”™è¯¯
                        if (action !== 'stop') {
                            console.error('æœ€ç»ˆçŠ¶æ€æ›´æ–°å¤±è´¥:', error);
                        }
                    }
                }, 3000);
            }
        }

        // è·å–æ“ä½œåç§°
        function getActionName(action) {
            const names = {
                'start': 'å¯åŠ¨',
                'stop': 'åœæ­¢',
                'restart': 'é‡å¯'
            };
            return names[action] || action;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            // æ ¹æ®ç±»å‹é€‰æ‹©ä¸åŒçš„å›¾æ ‡
            let icon;
            switch(type) {
                case 'success':
                    icon = 'âœ…';
                    break;
                case 'error':
                    icon = 'âŒ';
                    break;
                case 'info':
                    icon = 'â„¹ï¸';
                    break;
                default:
                    icon = 'â€¢';
            }

            notification.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // æ›´æ–°TFTPæœåŠ¡å™¨çŠ¶æ€
        async function updateTFTPStatus() {
            const statusElement = document.getElementById('tftp-status');
            try {
                const response = await fetch('/api/tftp/status', {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const isRunning = data.status === 'running';

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusElement.className = `server-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                statusElement.innerHTML = `
                    <span>${isRunning ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                    ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                `;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.getElementById('tftp-start').disabled = isRunning;
                document.getElementById('tftp-stop').disabled = !isRunning;
                document.getElementById('tftp-restart').disabled = !isRunning;
            } catch (error) {
                console.error('è·å–TFTPçŠ¶æ€å¤±è´¥:', error);
                // å½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå‡å®šæœåŠ¡å™¨å·²åœæ­¢
                statusElement.className = 'server-status status-stopped';
                statusElement.innerHTML = `
                    <span>ğŸ”´</span>
                    å·²åœæ­¢
                `;

                // æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºå¯å¯åŠ¨
                document.getElementById('tftp-start').disabled = false;
                document.getElementById('tftp-stop').disabled = true;
                document.getElementById('tftp-restart').disabled = true;
            }
        }

        // æ§åˆ¶TFTPæœåŠ¡å™¨
        async function controlTFTPServer(action) {
            const button = document.querySelector(`#tftp-${action}`);
            button.disabled = true;
            const statusElement = document.getElementById('tftp-status');

            try {
                // æ›´æ–°UIçŠ¶æ€ä¸ºå¤„ç†ï¿½ï¿½
                statusElement.className = 'server-status';
                statusElement.innerHTML = `
                    <span>ğŸ”„</span>
                    ${action === 'restart' ? 'é‡å¯ä¸­' : (action === 'start' ? 'å¯åŠ¨ä¸­' : 'åœæ­¢ä¸­')}...
                `;

                // å‘é€æ§åˆ¶å‘½ä»¤
                const response = await fetch(`/api/tftp/${action}`, {
                    method: 'POST',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                // ç«‹å³æ›´æ–°ä¸€æ¬¡çŠ¶æ€
                await updateTFTPStatus();

                // ç­‰å¾…æœåŠ¡å™¨çŠ¶æ€å˜åŒ–
                let attempts = 0;
                const maxAttempts = 15;
                const checkInterval = 500; // å‡å°‘æ£€æŸ¥é—´éš”åˆ°500ms
                let success = false;

                while (attempts < maxAttempts && !success) {
                    await new Promise(resolve => setTimeout(resolve, checkInterval));

                    try {
                        const statusResponse = await fetch('/api/tftp/status', {
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });

                        if (statusResponse.ok) {
                            const statusData = await statusResponse.json();
                            const currentStatus = statusData.status;

                            // ç«‹å³æ›´æ–°UIçŠ¶æ€
                            const isRunning = currentStatus === 'running';
                            statusElement.className = `server-status ${isRunning ? 'status-running' : 'status-stopped'}`;
                            statusElement.innerHTML = `
                                <span>${isRunning ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
                                ${isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
                            `;

                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            document.getElementById('tftp-start').disabled = isRunning;
                            document.getElementById('tftp-stop').disabled = !isRunning;
                            document.getElementById('tftp-restart').disabled = !isRunning;

                            if (action === 'stop' && currentStatus !== 'running') {
                                success = true;
                                showNotification('TFTPæœåŠ¡å™¨å·²åœæ­¢', 'success');
                                break;
                            } else if (action === 'start' && currentStatus === 'running') {
                                success = true;
                                showNotification('TFTPæœåŠ¡å™¨å·²å¯åŠ¨', 'success');
                                break;
                            } else if (action === 'restart' && currentStatus === 'running') {
                                success = true;
                                showNotification('TFTPæœåŠ¡å™¨å·²é‡å¯', 'success');
                                break;
                            }
                        }
                    } catch (error) {
                        console.log(`çŠ¶æ€æ£€æŸ¥å°è¯• ${attempts + 1}/${maxAttempts}`);
                    }
                    attempts++;
                }

                if (!success) {
                    throw new Error(`TFTPæœåŠ¡å™¨${getActionName(action)}è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€`);
                }
            } catch (error) {
                console.error(`TFTPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥:`, error);
                showNotification(`TFTPæœåŠ¡å™¨${getActionName(action)}å¤±è´¥: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                // æœ€ç»ˆæ›´æ–°çŠ¶æ€æ˜¾ç¤º
                await updateTFTPStatus();
                // å¯åŠ¨å®šæœŸçŠ¶æ€æ£€æŸ¥
                if (!statusCheckInterval) {
                    statusCheckInterval = setInterval(checkStatus, 10000);
                }
            }
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåçš„äº‹ä»¶ç›‘å¬å™¨ä¸­æ·»åŠ TFTPçŠ¶æ€æ›´æ–°
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig('ipxe');
            loadConfig('dhcp');
            loadConfig('http');
            loadIPXEConfig();
            updateDHCPStatus();
            updateHTTPStatus();
            updateTFTPStatus();

            let statusCheckInterval;
            let consecutiveErrors = 0;
            const maxConsecutiveErrors = 3;

            // åˆ›å»ºçŠ¶æ€æ£€æŸ¥å‡½æ•°
            const checkStatus = async () => {
                try {
                    await updateHTTPStatus();
                    await updateTFTPStatus();  // å–æ¶ˆæ³¨é‡Šï¼Œæ¢å¤TFTPçŠ¶æ€æ›´æ–°
                    await updateDHCPStatus();
                    consecutiveErrors = 0;
                } catch (error) {
                    consecutiveErrors++;
                    console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);

                    // å¦‚æœè¿ç»­å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œå¢åŠ æ£€æŸ¥é—´éš”
                    if (consecutiveErrors >= maxConsecutiveErrors) {
                        clearInterval(statusCheckInterval);
                        statusCheckInterval = setInterval(checkStatus, 30000);  // åˆ‡æ¢åˆ°30ç§’é—´éš”
                        console.log('æ£€æµ‹åˆ°å¤šæ¬¡è¿æ¥å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°ä½é¢‘ç‡æ£€æŸ¥æ¨¡å¼');
                    }
                }
            };

            // å¼€å§‹å®šæœŸæ£€æŸ¥
            statusCheckInterval = setInterval(checkStatus, 10000);

            // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    // é¡µé¢å˜ä¸ºå¯è§æ—¶ç«‹å³æ£€æŸ¥ä¸€æ¬¡
                    checkStatus();
                }
            });
        });

        // ä¿®æ”¹ uploadImage å‡½æ•°
        function uploadImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.iso,.img';
            input.style.display = 'none';
            document.body.appendChild(input);

            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) {
                    document.body.removeChild(input);
                    return;
                }

                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 10 * 1024 * 1024 * 1024) { // 10GB é™åˆ¶
                    showNotification('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº 10GB çš„æ–‡ä»¶', 'error');
                    document.body.removeChild(input);
                    return;
                }

                const formData = new FormData();
                formData.append('file', file, encodeURIComponent(file.name));

                try {
                    showNotification('å¼€å§‹ä¸Šä¼ é•œåƒ...', 'info');
                    const response = await fetch('/iso/upload', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(await response.text());
                    }

                    showNotification('é•œåƒä¸Šä¼ æˆåŠŸ', 'success');
                    await loadImages();
                } catch (error) {
                    console.error('ä¸Šä¼ é•œåƒå¤±è´¥:', error);
                    showNotification(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    document.body.removeChild(input);
                }
            };

            input.click();
        }

        // æ›´æ–°åŠ è½½é•œåƒåˆ—è¡¨å‡½æ•°
        async function loadImages() {
            const imageList = document.querySelector('.image-list');
            const header = imageList.querySelector('.image-list-header');

            try {
                // è·å–ISOæ˜ å°„å…³ç³»
                const mappingResponse = await fetch('/api/iso/mapping');
                const mapping = await mappingResponse.json();

                // è·å–æ–‡ä»¶åˆ—è¡¨
                const response = await fetch('/iso');
                const text = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const files = Array.from(doc.querySelectorAll('a')).filter(a =>
                    a.href.toLowerCase().endsWith('.iso') ||
                    a.href.toLowerCase().endsWith('.img')
                );

                // æ¸…é™¤ç°æœ‰å†…å®¹ï¼Œä¿ç•™è¡¨å¤´
                imageList.innerHTML = '';
                imageList.appendChild(header);

                if (files.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'image-list-empty';
                    emptyDiv.textContent = 'æš‚æ— é•œåƒæ–‡ä»¶';
                    imageList.appendChild(emptyDiv);
                    return;
                }

                // æ·»åŠ é•œåƒåˆ—è¡¨
                for (const file of files) {
                    const fileName = decodeURIComponent(file.href.split('/').pop());
                    const mappingInfo = mapping[fileName];
                    const statResponse = await fetch(`/iso/${fileName}`, { method: 'HEAD' });
                    const size = statResponse.headers.get('content-length');
                    const lastModified = statResponse.headers.get('last-modified');

                    const imageElement = document.createElement('div');
                    imageElement.className = 'image-item';
                    imageElement.innerHTML = `
                        <div class="image-info">
                            <span class="image-name">${fileName}</span>
                            <div class="image-meta">
                                <span>å¤§å°: ${formatSize(size)}</span>
                                <span>æ›´æ–°æ—¶é—´: ${new Date(lastModified).toLocaleDateString('zh-CN')}</span>
                                ${mappingInfo ? `
                                    <span>æœ¬åœ°è·¯å¾„: ${mappingInfo.pxe_path}</span>
                                    <span>è®¿é—®åœ°å€: <a href="${mappingInfo.url_path}" target="_blank">${mappingInfo.url_path}</a></span>
                                ` : '<span class="warning">æœªå¤„ç†</span>'}
                            </div>
                        </div>
                        <div class="image-actions">
                            ${mappingInfo ? `
                                <button class="btn btn-secondary btn-sm" onclick="viewISODetails('${fileName}')">
                                    <span>æŸ¥çœ‹</span>è¯¦æƒ…
                                </button>
                            ` : `
                                <button class="btn btn-primary btn-sm" onclick="processISO('${fileName}')">
                                    <span>å¤„ç†</span>
                                </button>
                            `}
                            <button class="btn btn-danger btn-sm" onclick="deleteImage('${fileName}')">
                                <span>ğŸ—‘ï¸</span>åˆ é™¤
                            </button>
                        </div>
                    `;
                    imageList.appendChild(imageElement);
                }
            } catch (error) {
                console.error('åŠ è½½é•œåƒåˆ—è¡¨å¤±è´¥:', error);
                showNotification('åŠ è½½é•œåƒåˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°åˆ é™¤é•œåƒå‡½æ•°
        async function deleteImage(fileName) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é•œåƒ "${fileName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/iso/${encodeURIComponent(fileName)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`åˆ é™¤å¤±è´¥: ${response.statusText}`);
                }

                showNotification('é•œåƒåˆ é™¤æˆåŠŸ', 'success');
                await loadImages();
            } catch (error) {
                console.error('åˆ é™¤é•œåƒå¤±è´¥:', error);
                showNotification(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                const deviceList = document.querySelector('.device-list');

                // ä¿ç•™è¡¨å¤´
                const header = deviceList.querySelector('.device-list-header');
                deviceList.innerHTML = '';
                deviceList.appendChild(header);

                // æ·»åŠ è®¾å¤‡åˆ—è¡¨
                devices.forEach(device => {
                    const deviceElement = document.createElement('div');
                    deviceElement.className = 'device-item';
                    deviceElement.innerHTML = `
                        <span class="device-mac">${device.mac}</span>
                        <span>${device.ip || '-'}</span>
                        <span class="device-bios">${device.bios_mode || 'Unknown'}</span>
                        <span>${device.boot_file || '-'}</span>
                        <div class="device-status ${device.online ? 'online' : 'offline'}">
                            ${device.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </div>
                        <div class="device-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editDevice('${device.mac}')">
                                <span>ğŸ“</span>ç¼–è¾‘
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteDevice('${device.mac}')">
                                <span>ğŸ—‘ï¸</span>åˆ é™¤
                            </button>
                        </div>
                    `;
                    deviceList.appendChild(deviceElement);
                });
            } catch (error) {
                showNotification('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(1)}${units[unitIndex]}`;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('zh-CN');
        }

        function editDevice(mac) {
            // TODO: å®ç°è®¾å¤‡ç¼–è¾‘åŠŸèƒ½
            console.log('ç¼–è¾‘è®¾å¤‡:', mac);
        }

        async function deleteDevice(mac) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è®¾å¤‡ ${mac} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                return;
            }

            try {
                // å°†MACåœ°å€ä¸­çš„å†’å·æ›¿æ¢ä¸ºè¿å­—ç¬¦ï¼Œä»¥é¿å…URLç¼–ç é—®é¢˜
                const formattedMac = mac.toLowerCase().replace(/:/g, '-');
                const response = await fetch(`/api/devices/${formattedMac}`, {
                    method: 'DELETE'
                });

                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || data.message || 'åˆ é™¤å¤±è´¥');
                    }
                    showNotification(data.message || 'è®¾å¤‡å·²åˆ é™¤', 'success');
                } else {
                    if (!response.ok) {
                        const text = await response.text();
                        // å°è¯•ä»HTMLå“åº”ä¸­æå–é”™è¯¯æ¶ˆæ¯
                        const messageMatch = text.match(/Message: ([^<]+)/);
                        throw new Error(messageMatch ? messageMatch[1] : 'åˆ é™¤å¤±è´¥');
                    }
                    showNotification('è®¾å¤‡å·²åˆ é™¤', 'success');
                }

                await loadDevices();  // é‡æ–°åŠ è½½è®¾å¤‡åˆ—è¡¨
            } catch (error) {
                console.error('åˆ é™¤è®¾å¤‡å¤±è´¥:', error);
                showNotification('åˆ é™¤è®¾å¤‡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ æ–°çš„iPXEé…ç½®ç›¸å…³å‡½æ•°
        async function loadIPXEConfig() {
            try {
                // åŠ è½½bootfiles
                const bootfilesResponse = await fetch('/api/bootfiles');
                const bootfilesData = await bootfilesResponse.json();

                // æ›´æ–°selecté€‰é¡¹
                const efiSelect = document.getElementById('efi-file');
                if (bootfilesData.files && bootfilesData.files.length > 0) {
                    efiSelect.innerHTML = bootfilesData.files
                        .map(file => `<option value="${file}">${file}</option>`)
                        .join('');
                } else {
                    // å¦‚æœæ²¡æœ‰åŠ è½½åˆ°æ–‡ä»¶ï¼Œæ˜¾ç¤ºé»˜è®¤é€‰é¡¹
                    efiSelect.innerHTML = `
                        <option value="snponlyx64.efi">snponlyx64.efi</option>
                        <option value="snponlyx86.efi">snponlyx86.efi</option>
                        <option value="ipxe.efi">ipxe.efi</option>
                    `;
                }

                // åŠ è½½å½“å‰é…ç½®
                const configResponse = await fetch('/api/config/ipxe');
                const contentType = configResponse.headers.get("content-type");
                let config;

                if (contentType && contentType.includes("application/json")) {
                    config = await configResponse.json();
                } else {
                    // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                    config = { boot_filename: "ipxe.efi" };
                }

                // å¦‚æœé…ç½®ä¸­æœ‰boot_filenameï¼Œè®¾ç½®å¯¹åº”çš„å€¼
                if (config.boot_filename && bootfilesData.files.includes(config.boot_filename)) {
                    efiSelect.value = config.boot_filename;
                } else if (bootfilesData.files && bootfilesData.files.length > 0) {
                    // å¦‚æœæ²¡æœ‰é…ç½®å€¼ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºé»˜è®¤å€¼
                    efiSelect.value = bootfilesData.files[0];
                }
            } catch (error) {
                console.error('åŠ è½½iPXEé…ç½®å¤±è´¥:', error);
                showNotification('åŠ è½½iPXEé…ç½®å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function saveIPXEConfig() {
            try {
                const config = {
                    boot_filename: document.getElementById('efi-file').value  // ä½¿ç”¨boot_filenameä½œä¸ºé”®
                };

                const response = await fetch('/api/config/ipxe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showNotification('iPXEé…ç½®å·²æ›´æ–°', 'success');
                } else {
                    throw new Error('ä¿å­˜å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜iPXEé…ç½®å¤±è´¥:', error);
                showNotification('ä¿å­˜iPXEé…ç½®å¤±è´¥', 'error');
            }
        }

        // ä¿®æ”¹æŸ¥çœ‹ISOè¯¦æƒ…çš„å‡½æ•°
        async function viewISODetails(fileName) {
            try {
                const response = await fetch(`/api/iso/info/${fileName}`);
                const info = await response.json();

                // åˆ›å»ºæ¨¡æ€å¯¹è¯æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                        <h3>ISOæ–‡ä»¶è¯¦æƒ…</h3>
                        <p><strong>æ–‡ä»¶å</strong> <span>${fileName}</span></p>
                        <p><strong>ID</strong> <span>${info.id}</span></p>
                        <p><strong>æœ¬åœ°è·¯å¾„</strong> <span>${info.pxe_path}</span></p>
                        <p><strong>è®¿é—®åœ°å€</strong> <a href="${info.url_path}" target="_blank">${info.url_path}</a></p>
                        <p><strong>æ–‡ä»¶å¤§å°</strong> <span>${formatSize(info.size)}</span></p>
                    </div>
                `;

                // æ·»åŠ ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†çš„åŠŸèƒ½
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€æ¡†çš„åŠŸèƒ½
                document.addEventListener('keydown', function closeOnEsc(e) {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', closeOnEsc);
                    }
                });

                document.body.appendChild(modal);
            } catch (error) {
                showNotification('è·å–ISOè¯¦æƒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ·»åŠ æ‰‹åŠ¨å¤„ç†ISOçš„å‡½æ•°
        async function processISO(fileName) {
            try {
                const response = await fetch(`/api/iso/process/${fileName}`, { method: 'POST' });
                if (response.ok) {
                    showNotification('ISOæ–‡ä»¶å¤„ç†æˆåŠŸ', 'success');
                    await loadImages();  // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showNotification('å¤„ç†ISOæ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°è®¾å¤‡åˆ—è¡¨æ˜¾ç¤º
        function updateDeviceList(devices) {
            const deviceList = document.querySelector('.device-list');
            if (!deviceList) return;

            deviceList.innerHTML = devices.map(device => `
                <tr>
                    <td>${device.mac}</td>
                    <td>${device.ip}</td>
                    <td>${device.bios_mode || 'Unknown'}</td>
                    <td>${device.boot_file || '-'}</td>
                    <td><span class="status-${device.status === 'åœ¨çº¿' ? 'online' : 'offline'}">${device.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-edit" onclick="editDevice('${device.mac}')">
                            <span>ğŸ“</span>ç¼–è¾‘
                        </button>
                        <button class="btn btn-sm btn-delete" onclick="deleteDevice('${device.mac}')">
                            <span>ğŸ—‘ï¸</span>åˆ é™¤
                        </button>
                    </td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>